<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>New Client Evaluation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
</head>
<body class="bg-light">
<div th:replace="~{fragments/navbar :: navbar('evaluation')}"></div>
<div class="container py-5 d-flex flex-column min-vh-100">

    <!-- Content wrapper so the form stays centered and narrow -->
    <div class="mx-auto" style="max-width: 600px;">

        <h5 class="intro-text mx-auto mb-4 text-center">
            Welcome new clients! Please complete the required<br> information to submit your evaluation.<br>
            Please provide your vaccination and pet license records if you have them available.<br>
            If not, don't worry. Bring them with you during<br> your in-person meeting—excited to meet your pup, and you!
        </h5>

        <p class="intro-text mx-auto mb-4 text-center">
            After submitting the evaluation, you will receive an email with further instructions.
        </p>

        <div class="card shadow p-4">
            <h1 class="mb-4 text-center">New Client Evaluation</h1>
            <div th:if="${errors}" class="alert alert-danger">
                <ul>
                    <li th:each="err : ${errors}" th:text="${err.defaultMessage}"></li>
                </ul>
            </div>

            <form method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="mb-3">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-control" name="clientName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone</label>
                    <input type="text" class="form-control" name="phone" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" name="email" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Dog Name</label>
                    <input type="text" class="form-control" name="dogName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Dog Breed</label>
                    <input type="text" class="form-control" name="dogBreed" required>
                </div>

                <!-- Additional Dogs Section -->
                <div class="mt-3" id="additional-dogs-section">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="m-0">Additional Dogs <span class="text-muted">(optional)</span></h6>
                        <small class="text-muted">Up to 4 more (5 total)</small>
                    </div>

                    <div id="additional-dogs-container"></div>

                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-dog-btn">
                        + Add another dog
                    </button>
                    <div class="form-text" id="add-dog-help">
                        “1 dog” is the default. Only add more if needed.
                    </div>
                </div>

                <!-- Template for an extra dog row -->
                <template id="additional-dog-row-template">
                    <div class="card p-3 mb-2 additional-dog-row">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="mb-0">Dog <span class="additional-dog-index"></span></strong>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-dog-btn" aria-label="Remove dog">Remove</button>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Dog name</label>
                                <input type="text" class="form-control" name="additionalDogNames" placeholder="e.g., Bella">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Dog breed</label>
                                <input type="text" class="form-control" name="additionalDogBreeds" placeholder="e.g., Labrador Retriever">
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Multi-file upload (up to 3 files) -->
                <div class="mb-3" id="upload-section">
                    <label class="form-label d-flex justify-content-between align-items-center">
                        <span>Upload Vaccine/Pet License</span>
                        <small class="text-muted">Up to 5 files</small>
                    </label>

                    <div id="upload-inputs-container"></div>

                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="add-file-btn">
                        + Add another file
                    </button>
                    <div class="form-text">You can add up to 5 attachments.</div>
                </div>

                <!-- Template for an extra file input -->
                <template id="upload-input-template">
                    <div class="d-flex gap-2 align-items-center mb-2 upload-input-row">
                        <input type="file" class="form-control" name="files" />
                        <button type="button" class="btn btn-outline-danger btn-sm remove-file-btn">Remove</button>
                    </div>
                </template>

                <button type="submit" class="btn btn-primary btn-lg mt-3 w-100">Submit Evaluation</button>
            </form>
        </div>
    </div>

    <!-- Back button pinned to bottom when there's extra space -->
    <div class="mt-auto pt-4 d-grid d-md-flex justify-content-md-center">
        <a class="btn btn-secondary" th:href="@{/}">Back to Homepage</a>
    </div>
</div>
<script th:src="@{/js/custom.js}"></script>
<script>
    (function () {
        const MAX_TOTAL_DOGS = 5;               // includes the first dog
        const MAX_EXTRAS = MAX_TOTAL_DOGS - 1;  // 4 extras
        const addBtn = document.getElementById('add-dog-btn');
        const container = document.getElementById('additional-dogs-container');
        const tmpl = document.getElementById('additional-dog-row-template');

        function updateIndices() {
            const rows = container.querySelectorAll('.additional-dog-row');
            rows.forEach((row, i) => {
                const idxEl = row.querySelector('.additional-dog-index');
                if (idxEl) idxEl.textContent = String(i + 2); // first dog is #1
            });
        }

        function updateButtonState() {
            const count = container.querySelectorAll('.additional-dog-row').length;
            addBtn.disabled = count >= MAX_EXTRAS;
        }

        function addExtraDogRow() {
            const count = container.querySelectorAll('.additional-dog-row').length;
            if (count >= MAX_EXTRAS) return;

            const node = tmpl.content.cloneNode(true);
            node.querySelector('.remove-dog-btn').addEventListener('click', function () {
                this.closest('.additional-dog-row').remove();
                updateIndices();
                updateButtonState();
            });
            container.appendChild(node);
            updateIndices();
            updateButtonState();
        }

        if (addBtn && container && tmpl) {
            addBtn.addEventListener('click', addExtraDogRow);
            updateButtonState();
        }
    })();
</script>
<script>
    (function () {
        const MAX_FILES = 5;
        const addBtn = document.getElementById('add-file-btn');
        const container = document.getElementById('upload-inputs-container');
        const tmpl = document.getElementById('upload-input-template');

        function countRows() {
            return container.querySelectorAll('.upload-input-row').length;
        }

        function updateButtonState() {
            addBtn.disabled = countRows() >= MAX_FILES;
        }

        function addFileRow() {
            if (countRows() >= MAX_FILES) return;
            const node = tmpl.content.cloneNode(true);
            node.querySelector('.remove-file-btn').addEventListener('click', function () {
                this.closest('.upload-input-row').remove();
                if (countRows() === 0) ensureAtLeastOne();
                updateButtonState();
            });
            container.appendChild(node);
            updateButtonState();
        }

        function ensureAtLeastOne() {
            if (countRows() === 0) addFileRow();
        }

        if (addBtn && container && tmpl) {
            addBtn.addEventListener('click', addFileRow);
            // Start with one input by default
            ensureAtLeastOne();
            updateButtonState();
        }
    })();
</script>
</body>
</html>