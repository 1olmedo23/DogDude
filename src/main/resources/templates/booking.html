<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Book a Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <!-- Keep our banners from auto-hiding -->
    <style>
        .alert.alert-static {
            animation: none !important;
            opacity: 1 !important;
            transition: none !important;
        }
        .alert.alert-static { animation: none !important; opacity: 1 !important; }
        /* Service button active styles */
        .svc-btn.active { box-shadow: 0 0 0 .2rem rgba(0,0,0,.08); }
        /* Compact badges in booking lists */
        .badge-status { font-weight: 500; }
    </style>
</head>
<body class="bg-light">
<div th:replace="~{fragments/navbar :: navbar('booking')}"></div>

<div class="container py-5">
    <h1 class="mb-4">Book a Service</h1>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-4" id="custTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="tab-booking" data-bs-toggle="tab" data-bs-target="#pane-booking" type="button" role="tab">
                Booking
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-uploads" data-bs-toggle="tab" data-bs-target="#pane-uploads" type="button" role="tab">
                Uploads
            </button>
        </li>
    </ul>

    <!-- Alerts -->
    <div class="alert alert-danger"
         th:if="${errorMessage != null and !#strings.isEmpty(errorMessage)}"
         th:text="${errorMessage}"></div>

    <div class="alert alert-success"
         th:if="${successMessage != null and !#strings.isEmpty(successMessage)}"
         th:text="${successMessage}"></div>

    <div class="tab-content" id="custTabsContent">
        <!-- Booking pane -->
        <div class="tab-pane fade show active" id="pane-booking" role="tabpanel" aria-labelledby="tab-booking">

            <!-- Two-week navigator -->
            <div class="d-flex align-items-center justify-content-between mb-3">
                <a class="btn btn-outline-secondary" th:href="@{|/booking?start=${prevStart}|}">← Previous 2 Weeks</a>
                <div class="text-muted small">
                    Showing weeks of
                    <strong th:text="${#temporals.format(week1Monday, 'MMM d')}">Mar 1</strong>
                    and
                    <strong th:text="${#temporals.format(week2Monday, 'MMM d')}">Mar 8</strong>
                </div>
                <a class="btn btn-outline-secondary" th:href="@{|/booking?start=${nextStart}|}">Next 2 Weeks →</a>
            </div>

            <!-- WEEK 1 (full width) -->
            <div class="card shadow-sm mb-4">
                <div class="card-body" th:with="weekPaid=${week1Paid}">
                <div class="alert alert-static mb-3"
                         data-permanent="true"
                         th:classappend="${week1Paid} ? ' alert-info' : ' alert-secondary'">
                        <div th:if="${!week1Paid}">
                            <strong>Plan your week:</strong> Book daycare days <em>≥24h in advance</em> to unlock discounted weekly rates.<br/>
                            Week:
                            <span th:text="${#temporals.format(week1Monday, 'MMM d')}"></span>
                            –
                            <span th:text="${#temporals.format(week1Monday.plusDays(6), 'MMM d')}"></span>
                        </div>
                        <div th:if="${week1Paid}">
                            <strong>Week planned:</strong> You’ve already paid for this week’s daycare bundle. Additional daycare this week is regular rate.<br/>
                            Week:
                            <span th:text="${#temporals.format(week1Monday, 'MMM d')}"></span>
                            –
                            <span th:text="${#temporals.format(week1Monday.plusDays(6), 'MMM d')}"></span>
                        </div>
                    </div>

                    <!-- Days grid -->
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
                        <div class="col" th:each="d : ${week1Days}">
                            <div class="border rounded h-100 p-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong th:text="${#temporals.format(d, 'EEE MMM d')}">Mon Mar 1</strong>
                                </div>

                                <!-- 3 service buttons (now sticky-active) -->
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm svc-btn"
                                            data-variant="primary"
                                            data-service="Daycare (6 AM - 3 PM)" th:attr="data-date=${d}">Daycare</button>
                                    <button class="btn btn-outline-primary btn-sm svc-btn"
                                            data-variant="primary"
                                            data-service="Daycare (6 AM - 8 PM)" th:attr="data-date=${d}">Daycare Evening</button>
                                    <button class="btn btn-outline-secondary btn-sm svc-btn"
                                            data-variant="secondary"
                                            data-service="Boarding" th:attr="data-date=${d}">Boarding</button>
                                </div>

                                <!-- hidden inline booking form -->
                                <form class="mt-2 d-none day-form" method="post" th:action="@{/booking}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="serviceType">
                                    <input type="hidden" name="date">
                                    <div class="mb-2">
                                        <label class="form-label small">Drop-off time</label>
                                        <select name="time" class="form-select form-select-sm" required>
                                            <option th:each="t : ${dropoffTimes}" th:value="${t}" th:text="${t}">06:00</option>
                                        </select>
                                    </div>
                                    <!-- Daycare-only prepay -->
                                    <div class="form-check mb-2 small daycare-only"
                                         th:classappend="${weekPaid} ? ' opacity-50' : ''">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="wantsAdvancePay"
                                               value="true"
                                               th:disabled="${weekPaid}">
                                        <label class="form-check-label">Pay in advance for discounted weekly rate</label>
                                        <div class="form-text" data-prepay-msg
                                             th:text="${weekPaid} ? 'This week is already paid. Additional daycare is at regular rate.' : 'Must be booked ≥ 24 hours in advance to qualify.'">
                                            Must be booked ≥ 24 hours in advance to qualify.
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-custom btn-sm">Book</button>
                                    </div>
                                </form>
                            </div>
                        </div><!-- /col -->
                    </div>
                </div>
            </div>

            <!-- WEEK 2 (full width) -->
            <div class="card shadow-sm mb-4">
                <div class="card-body" th:with="weekPaid=${week1Paid}">
                <div class="alert alert-static mb-3"
                         data-permanent="true"
                         th:classappend="${week2Paid} ? ' alert-info' : ' alert-secondary'">
                        <div th:if="${!week2Paid}">
                            <strong>Plan your week:</strong> Book daycare days <em>≥24h in advance</em> to unlock discounted weekly rates.<br/>
                            Week:
                            <span th:text="${#temporals.format(week2Monday, 'MMM d')}"></span>
                            –
                            <span th:text="${#temporals.format(week2Monday.plusDays(6), 'MMM d')}"></span>
                        </div>
                        <div th:if="${week2Paid}">
                            <strong>Week planned:</strong> You’ve already paid for this week’s daycare bundle. Additional daycare this week is regular rate.<br/>
                            Week:
                            <span th:text="${#temporals.format(week2Monday, 'MMM d')}"></span>
                            –
                            <span th:text="${#temporals.format(week2Monday.plusDays(6), 'MMM d')}"></span>
                        </div>
                    </div>

                    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
                        <div class="col" th:each="d : ${week2Days}">
                            <div class="border rounded h-100 p-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong th:text="${#temporals.format(d, 'EEE MMM d')}">Mon Mar 8</strong>
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm svc-btn"
                                            data-variant="primary"
                                            data-service="Daycare (6 AM - 3 PM)" th:attr="data-date=${d}">Daycare</button>
                                    <button class="btn btn-outline-primary btn-sm svc-btn"
                                            data-variant="primary"
                                            data-service="Daycare (6 AM - 8 PM)" th:attr="data-date=${d}">Daycare Evening</button>
                                    <button class="btn btn-outline-secondary btn-sm svc-btn"
                                            data-variant="secondary"
                                            data-service="Boarding" th:attr="data-date=${d}">Boarding</button>
                                </div>

                                <form class="mt-2 d-none day-form" method="post" th:action="@{/booking}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="serviceType">
                                    <input type="hidden" name="date">
                                    <div class="mb-2">
                                        <label class="form-label small">Drop-off time</label>
                                        <select name="time" class="form-select form-select-sm" required>
                                            <option th:each="t : ${dropoffTimes}" th:value="${t}" th:text="${t}">06:00</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2 small daycare-only"
                                         th:classappend="${weekPaid} ? ' opacity-50' : ''">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="wantsAdvancePay"
                                               value="true"
                                               th:disabled="${weekPaid}">
                                        <label class="form-check-label">Pay in advance for discounted weekly rate</label>
                                        <div class="form-text" data-prepay-msg
                                             th:text="${weekPaid} ? 'This week is already paid. Additional daycare is at regular rate.' : 'Must be booked ≥ 24 hours in advance to qualify.'">
                                            Must be booked ≥ 24 hours in advance to qualify.
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-custom btn-sm">Book</button>
                                    </div>
                                </form>
                            </div>
                        </div><!-- /col -->
                    </div>
                </div>
            </div>

            <!-- Your Bookings (tidied) -->
            <h3 class="mt-5">Your Bookings</h3>
            <div class="row gy-4">
                <div class="col-md-4">
                    <h5 class="mb-2">Daycare (6 AM - 3 PM)</h5>
                    <ul class="list-group">
                        <li th:each="b : ${bookingsDaycareShort}" class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold" th:text="${b.serviceType}">Daycare (6 AM - 3 PM)</div>
                                <div class="text-muted small">
                                    <span th:text="${#temporals.format(b.date, 'MM/dd/yy')}">03/01/25</span>
                                    • Drop-off at
                                    <span th:text="${b.time != null ? #temporals.format(b.time, 'h:mm a') : '—'}">6:00 AM</span>
                                </div>
                                <div class="mt-1">
                                    <span class="badge badge-status"
                                          th:classappend="${b.status == 'APPROVED'} ? ' bg-success-subtle text-success' :
                                                          (${b.status == 'CANCELED'} ? ' bg-danger-subtle text-danger' : ' bg-secondary')"
                                          th:text="${b.status}">APPROVED</span>
                                    <span class="badge bg-light text-dark ms-2">
                                        <span th:if="${provisionalQuotes != null and provisionalQuotes[b.id] != null}"
                                              th:text="${#numbers.formatCurrency(provisionalQuotes[b.id])}">$0.00</span>
                                        <span th:if="${provisionalQuotes == null or provisionalQuotes[b.id] == null}">est.</span>
                                    </span>
                                </div>
                            </div>
                            <div th:if="${b.status == 'APPROVED'}">
                                <form th:action="@{'/booking/cancel/' + ${b.id}}"
                                      method="post"
                                      class="ms-3 confirm-cancel">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button class="btn btn-danger-custom btn-sm" type="submit">Cancel</button>
                                </form>

                            </div>
                        </li>
                        <li th:if="${#lists.isEmpty(bookingsDaycareShort)}" class="list-group-item text-muted">No bookings.</li>
                    </ul>
                </div>

                <div class="col-md-4">
                    <h5 class="mb-2">Daycare (6 AM - 8 PM)</h5>
                    <ul class="list-group">
                        <li th:each="b : ${bookingsDaycareLong}" class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold" th:text="${b.serviceType}">Daycare (6 AM - 8 PM)</div>
                                <div class="text-muted small">
                                    <span th:text="${#temporals.format(b.date, 'MM/dd/yy')}">03/01/25</span>
                                    • Drop-off at
                                    <span th:text="${b.time != null ? #temporals.format(b.time, 'h:mm a') : '—'}">6:00 AM</span>
                                </div>
                                <div class="mt-1">
                                    <span class="badge badge-status"
                                          th:classappend="${b.status == 'APPROVED'} ? ' bg-success-subtle text-success' :
                                                          (${b.status == 'CANCELED'} ? ' bg-danger-subtle text-danger' : ' bg-secondary')"
                                          th:text="${b.status}">APPROVED</span>
                                    <span class="badge bg-light text-dark ms-2">
                                        <span th:if="${provisionalQuotes != null and provisionalQuotes[b.id] != null}"
                                              th:text="${#numbers.formatCurrency(provisionalQuotes[b.id])}">$0.00</span>
                                        <span th:if="${provisionalQuotes == null or provisionalQuotes[b.id] == null}">est.</span>
                                    </span>
                                </div>
                            </div>
                            <div th:if="${b.status == 'APPROVED'}">
                                <form th:action="@{'/booking/cancel/' + ${b.id}}"
                                      method="post"
                                      class="ms-3 confirm-cancel">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button class="btn btn-danger-custom btn-sm" type="submit">Cancel</button>
                                </form>
                            </div>
                        </li>
                        <li th:if="${#lists.isEmpty(bookingsDaycareLong)}" class="list-group-item text-muted">No bookings.</li>
                    </ul>
                </div>

                <div class="col-md-4">
                    <h5 class="mb-2">Boarding</h5>
                    <ul class="list-group">
                        <li th:each="b : ${bookingsBoarding}" class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold" th:text="${b.serviceType}">Boarding</div>
                                <div class="text-muted small">
                                    <span th:text="${#temporals.format(b.date, 'MM/dd/yy')}">03/01/25</span>
                                    <span th:if="${b.time != null}"> • Drop-off at <span th:text="${#temporals.format(b.time, 'h:mm a')}">6:00 AM</span></span>
                                </div>
                                <div class="mt-1">
                                    <span class="badge badge-status"
                                          th:classappend="${b.status == 'APPROVED'} ? ' bg-success-subtle text-success' :
                                                          (${b.status == 'CANCELED'} ? ' bg-danger-subtle text-danger' : ' bg-secondary')"
                                          th:text="${b.status}">APPROVED</span>
                                    <span th:if="${b.quotedRateAtLock != null}" class="badge bg-light text-dark ms-2"
                                          th:text="${#numbers.formatCurrency(b.quotedRateAtLock)}">$0.00</span>
                                </div>
                            </div>
                            <div th:if="${b.status == 'APPROVED'}">
                                <form th:action="@{'/booking/cancel/' + ${b.id}}"
                                      method="post"
                                      class="ms-3 confirm-cancel">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button class="btn btn-danger-custom btn-sm" type="submit">Cancel</button>
                                </form>
                            </div>
                        </li>
                        <li th:if="${#lists.isEmpty(bookingsBoarding)}" class="list-group-item text-muted">No bookings.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Uploads pane -->
        <div class="tab-pane fade" id="pane-uploads" role="tabpanel" aria-labelledby="tab-uploads">
            <h3 class="mb-3">Upload Vaccine/Records</h3>

            <form th:action="@{/uploads}" method="post" enctype="multipart/form-data" class="row g-3">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="col-md-4">
                    <label class="form-label">File</label>
                    <input type="file" class="form-control" name="file" required>
                    <div class="form-text">Allowed: PDF, JPG, PNG (max 10MB)</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Display name (optional)</label>
                    <input type="text" class="form-control" name="displayName" placeholder="Rabies Vaccine">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Expiration date (optional)</label>
                    <input type="date" class="form-control" name="expirationDate">
                </div>
                <div class="col-12">
                    <button class="btn btn-custom">Upload</button>
                </div>
            </form>

            <hr class="my-4"/>

            <h4>Your Files</h4>
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>File</th>
                        <th>Display Name</th>
                        <th>Expires</th>
                        <th>Uploaded</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="f : ${files}">
                        <td th:text="${f.fileName}">VetRecord.pdf</td>
                        <td th:text="${f.displayName != null ? f.displayName : '—'}">Rabies Vaccine</td>
                        <td th:text="${f.expirationDate != null ? f.expirationDate : '—'}">2026-05-01</td>
                        <td th:text="${#temporals.format(f.createdAt, 'yyyy-MM-dd HH:mm')}">2025-09-03 10:15</td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-secondary" th:href="@{'/uploads/' + ${f.id} + '/download'}">Download</a>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(files)}"><td colspan="5" class="text-center text-muted">No files uploaded yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/custom.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Tabs (hash) -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const activateFromHash = () => {
            const hash = window.location.hash;
            if (!hash) return;
            const btn = document.querySelector(`button[data-bs-target="${hash}"]`);
            if (btn && window.bootstrap) new bootstrap.Tab(btn).show();
            if (hash === '#uploads') {
                const ubtn = document.querySelector('#tab-uploads');
                if (ubtn && window.bootstrap) new bootstrap.Tab(ubtn).show();
            }
        };
        activateFromHash();
        window.addEventListener('hashchange', activateFromHash);
    });
</script>

<!-- Service selection + prepay eligibility (per day tile) -->
<script th:inline="javascript">
    (function() {
        function hoursUntil(dateStr, timeStr) {
            if (!dateStr || !timeStr) return 0;
            const dt = new Date(`${dateStr}T${timeStr}:00`);
            const now = new Date();
            return (dt.getTime() - now.getTime()) / (1000*60*60);
        }

        async function fetchWeekPaid(isoDate) {
            try {
                const res = await fetch(`/booking/week-paid?date=${encodeURIComponent(isoDate)}`, {
                    headers: { 'Accept': 'application/json' }
                });
                if (!res.ok) return { weekPaid: false };
                return await res.json();
            } catch {
                return { weekPaid: false };
            }
        }

        function setActive(btn, isActive) {
            const variant = btn.getAttribute('data-variant') || 'primary';
            btn.classList.toggle('active', isActive);
            // swap outline → solid when active, and back when inactive
            if (variant === 'secondary') {
                btn.classList.toggle('btn-outline-secondary', !isActive);
                btn.classList.toggle('btn-secondary', isActive);
            } else {
                btn.classList.toggle('btn-outline-primary', !isActive);
                btn.classList.toggle('btn-primary', isActive);
            }
        }

        function clearActiveSiblings(buttons) {
            buttons.forEach(b => setActive(b, false));
        }

        function wireDayTile(tile) {
            const svcButtons = tile.querySelectorAll('.svc-btn');
            const form = tile.querySelector('.day-form');
            if (!form) return;
            const svcInput = form.querySelector('input[name="serviceType"]');
            const dateInput = form.querySelector('input[name="date"]');
            const timeSelect = form.querySelector('select[name="time"]');
            const daycareBlock = form.querySelector('.daycare-only');
            const prepayChk = form.querySelector('input[name="wantsAdvancePay"]');
            const prepayMsg = form.querySelector('[data-prepay-msg]');

            async function refreshPrepay(serviceType, dateStr, timeStr) {
                const isDaycare = (serviceType || '').toLowerCase().includes('daycare');
                daycareBlock.classList.toggle('d-none', !isDaycare);
                if (!isDaycare) return;

                const info = await fetchWeekPaid(dateStr);
                const weekPaid = !!info.weekPaid;
                const hrs = hoursUntil(dateStr, timeStr);
                const eligible = !weekPaid && hrs >= 24;

                prepayChk.disabled = !eligible;
                if (!eligible && prepayChk.checked) prepayChk.checked = false;
                if (prepayMsg) {
                    prepayMsg.textContent = weekPaid
                        ? 'This week is already paid. Additional daycare bookings are regular rate.'
                        : (hrs >= 24 ? 'Eligible for advance-pay discount.' : 'Must be booked ≥ 24 hours in advance to qualify.');
                }
            }

            // On service click: reveal form, mark button active
            svcButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const svc = btn.getAttribute('data-service');
                    const d = btn.getAttribute('data-date');
                    form.classList.remove('d-none');
                    svcInput.value = svc;
                    dateInput.value = d;

                    // Visual selection
                    clearActiveSiblings(Array.from(svcButtons));
                    setActive(btn, true);

                    // Reset prepay and check eligibility
                    prepayChk.checked = false;
                    await refreshPrepay(svc, d, timeSelect.value);
                });
            });

            timeSelect.addEventListener('change', async () => {
                await refreshPrepay(svcInput.value, dateInput.value, timeSelect.value);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.border.rounded.h-100.p-2').forEach(wireDayTile);
        });
    })();
</script>

<!-- Keep ALL weekly banners permanently visible (guarded) -->
<script>
    (function () {
        const SELECTOR = '.alert.alert-static';

        function isActuallyHidden(el) {
            const cs = window.getComputedStyle(el);
            return el.hasAttribute('hidden') ||
                el.getAttribute('aria-hidden') === 'true' ||
                cs.display === 'none' ||
                cs.visibility === 'hidden' ||
                parseFloat(cs.opacity || '1') < 0.99;
        }

        function KEEP_VISIBLE(banner) {
            // Only act if truly hidden; otherwise do nothing
            if (!isActuallyHidden(banner)) return;

            banner.classList.add('alert-static');
            banner.removeAttribute('hidden');
            banner.removeAttribute('aria-hidden');
            banner.style.removeProperty('display');
            banner.style.visibility = 'visible';
            banner.style.opacity = '1';
            banner.style.removeProperty('animation');
            banner.style.removeProperty('transition');

            // Mark as pinned so we won't touch again
            banner.dataset.pinned = '1';
        }

        // Initial pass: fix any hidden banners
        document.querySelectorAll(SELECTOR).forEach(KEEP_VISIBLE);

        // Observe for third-party scripts trying to hide alerts later
        const observer = new MutationObserver((mutations, obs) => {
            // If everything already pinned/visible, bail quickly
            const banners = document.querySelectorAll(SELECTOR);
            let needsFix = false;
            banners.forEach(b => {
                if (b.dataset.pinned === '1') return; // we already fixed it once
                if (isActuallyHidden(b)) needsFix = true;
            });
            if (!needsFix) return;

            // Disconnect while fixing to avoid self-trigger loops
            obs.disconnect();
            banners.forEach(b => {
                if (b.dataset.pinned === '1') return;
                KEEP_VISIBLE(b);
            });
            // Reconnect for future external changes
            obs.observe(document.documentElement, {
                attributes: true,
                childList: true,
                subtree: true,
                attributeFilter: ['hidden', 'aria-hidden', 'class', 'style']
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            childList: true,
            subtree: true,
            attributeFilter: ['hidden', 'aria-hidden', 'class', 'style']
        });
    })();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('form.confirm-cancel').forEach(function (f) {
            f.addEventListener('submit', function (e) {
                if (!window.confirm('Cancel this booking? This cannot be undone.')) {
                    e.preventDefault();
                }
            });
        });
    });
</script>
</body>
</html>
