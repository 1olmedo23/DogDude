<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Book a Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/custom.css?v=20251103}">
    <style>
        /* --- small UX polish --- */
        .alert.alert-static{animation:none!important;opacity:1!important;transition:none!important}
        .svc-btn.active{box-shadow:0 0 0 .2rem rgba(0,0,0,.08)}
        .badge-status{font-weight:500}

        /* --- new layout accents --- */
        .section-card{
            border:1px solid var(--bs-border-color);
            border-radius:1rem;
            background:var(--bs-body-bg);
        }
        .section-card .section-head{
            border-bottom:1px dashed var(--bs-border-color);
            padding: .9rem 1.1rem;
            background:var(--bs-body-tertiary);
            border-top-left-radius:1rem;
            border-top-right-radius:1rem;
        }
        .section-card .section-body{ padding:1rem; }

        .planner-banner{
            border:1px solid var(--bs-info-border-subtle, #b6e0fe);
            background: var(--bs-info-bg-subtle, #e7f5ff);
            color: var(--bs-info-text-emphasis, #055160);
            border-radius:.75rem;
        }

        /* day tiles */
        .day-tile{ border:1px solid var(--bs-border-color); border-radius:.75rem; padding:.75rem; height:100%; }
        .day-tile .tile-head{ border-bottom:1px dashed var(--bs-border-color); padding-bottom:.35rem; margin-bottom:.6rem; }

        /* “Your Bookings” area */
        .bookings-wrap{ background:var(--bs-body-secondary); border:1px solid var(--bs-border-color); border-radius:1rem; }
        .bookings-wrap .wrap-head{
            border-bottom:1px dashed var(--bs-border-color);
            padding: .9rem 1.1rem;
            background:var(--bs-body-tertiary);
            border-top-left-radius:1rem;
            border-top-right-radius:1rem;
        }
        .bookings-wrap .wrap-body{ padding:1rem; }

        /* subtle horizontal separators */
        .hr-dashed{ border-top:1px dashed var(--bs-border-color); opacity:.7; }

        /* small helper */
        .text-compact{ max-width:70ch; margin-inline:auto; }
    </style>
</head>
<body class="bg-light">
<div th:replace="~{fragments/navbar :: navbar('booking')}"></div>

<div class="container-xxl py-5">

    <!-- Mobile sticky container for tabs -->
    <div class="mobile-sticky-tabs">
    <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="custTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="tab-booking"
                        data-bs-toggle="tab" data-bs-target="#pane-booking"
                        type="button" role="tab">Booking</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-your"
                        data-bs-toggle="tab" data-bs-target="#pane-your"
                        type="button" role="tab">Your Bookings</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-uploads"
                        data-bs-toggle="tab" data-bs-target="#pane-uploads"
                        type="button" role="tab">Uploads</button>
            </li>
        </ul>
    </div><!-- /mobile-sticky-tabs -->

    <!-- Alerts -->
    <div class="alert alert-danger"
         th:if="${errorMessage != null and !#strings.isEmpty(errorMessage)}"
         th:text="${errorMessage}"></div>

    <div class="alert alert-success"
         th:if="${successMessage != null and !#strings.isEmpty(successMessage)}"
         th:text="${successMessage}"></div>

    <div class="tab-content" id="custTabsContent">
        <!-- Booking pane -->
        <div class="tab-pane fade show active" id="pane-booking" role="tabpanel" aria-labelledby="tab-booking">
            <h1 id="pageTitle" class="mb-4 text-center">Book a Service</h1>

            <!-- Pricing / planning message (BOOKING TAB ONLY) -->
            <div class="planner-banner p-3 p-md-4 mb-4">
                <!-- Mobile header row with a toggle -->
                <div class="d-flex align-items-center justify-content-between d-md-none">
                    <h5 class="mb-0">Rates & Notes</h5>
                    <button class="btn btn-outline-primary btn-sm" type="button"
                            id="ratesToggleBtn" aria-controls="ratesCollapse">
                        View
                    </button>
                </div>

                <!-- Collapsible body (collapsed on < md, always shown on ≥ md) -->
                <div id="ratesCollapse" class="collapse d-md-block text-center mt-2 mt-md-0">
                    <h4 class="d-none d-md-block"><strong><u>Rates</u></strong></h4>
                    <strong>Regular Rate</strong> → $50/Daycare &amp; $60/Daycare + Evening.<br>
                    <strong>Daycare + After Hours:</strong> $90 - Flat Rate.<br>
                    <br>
                    <strong>Pay for daycare in advance to unlock discounts!</strong><br>
                    <div class="small text-compact">
                        <br>
                        <h4 class="d-none d-md-block"><strong><u>Discounted Rates</u></strong></h4>
                        Prepay <strong>1–3 days</strong> → $45/Daycare &amp; $50/Daycare + Evening.<br>
                        Prepay <strong>4+ days</strong> → $40/Daycare &amp; $45/Daycare + Evening.<br>
                        To activate your discount, select your desired daycare date below<br>
                        and check the "Pay in advance" box.<br>
                        <br>
                        <h4 class="d-none d-md-block"><strong><u>Notes</u></strong></h4>
                        When you pay in advance for a week, any bookings made after<br>
                        are counted as regular rate for that week.<br>
                        Daycare booked within 24 hours of drop off will not<br> count towards the discounted rate.<br>
                        Although, discounted boarding rates will be upheld even<br> if you book within 24 hours.
                        <br> Payment will be collected separately via phone or in person.<br>
                        <strong>A week is Monday through Sunday.</strong>
                        <br/><br/>
                        The price of <strong>boarding</strong> is a flat rate per night. However,<br> based on your prior month of scheduling you will qualify<br>
                        for a discounted boarding rate.
                        Even if you schedule within 24 hours.<br>
                        <br>
                        <h4 class="d-none d-md-block"><strong><u>Cancellations</u></strong></h4>
                        You can cancel at any time.<br>
                        Any cancellations made after payment will be counted towards<br> redeemable tickets
                        accepted up to 30-days after cancellation.<br>
                        Tickets will be automatically applied when booking future services.<br>
                        <strong>Boarding</strong> cancellations must be made 72 hours in advance.
                    </div>
                </div>
            </div>

            <!-- Two-week navigator (framed) -->
            <div class="section-card mb-4">
                <div class="section-head d-flex align-items-center justify-content-between">
                    <a class="btn btn-outline-secondary" th:href="@{|/booking?start=${prevStart}|}">← Previous 2 Weeks</a>

                    <a class="btn btn-outline-secondary" th:href="@{|/booking?start=${nextStart}|}">Next 2 Weeks →</a>
                </div>
                <div class="section-body pt-3">

                    <!-- WEEK 1 -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body" th:with="weekPaid=${week1Paid}">
                            <div class="alert alert-static mb-3 text-center"
                                 th:classappend="${week1Paid} ? ' alert-info' : ' alert-secondary'">
                                <div th:if="${!week1Paid}">
                                    <strong>Plan your week to unlock discounted rates.</strong><br/>
                                    Week:
                                    <span th:text="${#temporals.format(week1Monday, 'MMM d')}"></span>
                                    –
                                    <span th:text="${#temporals.format(week1Monday.plusDays(6), 'MMM d')}"></span>
                                </div>
                                <div th:if="${week1Paid}">
                                    <strong>Week planned:</strong> You’ve already paid for this week’s daycare bundle. Additional daycare this week is regular rate.<br/>
                                    Week:
                                    <span th:text="${#temporals.format(week1Monday, 'MMM d')}"></span>
                                    –
                                    <span th:text="${#temporals.format(week1Monday.plusDays(6), 'MMM d')}"></span>
                                </div>
                            </div>

                            <!-- Days grid -->
                            <div class="calendar-head">
                                <h5 class="mb-0"
                                    th:text="${#temporals.format(week1Monday, 'MMMM yyyy')}">March 2025</h5>
                            </div>
                            <!-- 7-column calendar grid -->
                            <div class="calendar-grid">
                                <!-- Optional weekday labels row -->
                                <div class="calendar-label">Mon</div>
                                <div class="calendar-label">Tue</div>
                                <div class="calendar-label">Wed</div>
                                <div class="calendar-label">Thu</div>
                                <div class="calendar-label">Fri</div>
                                <div class="calendar-label">Sat</div>
                                <div class="calendar-label">Sun</div>

                                <!-- Days -->
                                <div class="calendar-cell" th:each="d : ${week1Days}">
                                    <span class="badge text-bg-secondary small badge-booked"
                                          th:if="${#maps.containsKey(bookedByDate, d)}"
                                          th:text="${#strings.defaultString(bookedByDate[d], 'Booked')}">Booked</span>
                                    <div th:class="${'day-tile'
                                                      + (d.equals(today) ? ' is-today' : '')
                                                      + (#maps.containsKey(bookedByDate, d) ? ' is-booked' : '')}"
                                         th:attr="aria-current=${d.equals(today)} ? 'date' : null">
                                    <div class="tile-head d-flex justify-content-between align-items-center">
                                            <strong th:text="${#temporals.format(d, 'EEE MMM d')}">Mon Mar 1</strong>
                                            <div class="d-flex gap-2 align-items-center">
                                                <span class="badge bg-primary-subtle text-primary small"
                                                      th:if="${d.equals(today)}">Today</span>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm svc-btn"
                                                    data-variant="primary"
                                                    data-service="Daycare (6 AM - 3 PM)"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Daycare
                                            </button>

                                            <button class="btn btn-outline-primary btn-sm svc-btn"
                                                    data-variant="primary"
                                                    data-service="Daycare (6 AM - 8 PM)"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Daycare + Evening
                                            </button>

                                            <button class="btn btn-outline-primary btn-sm svc-btn"
                                                    data-variant="primary"
                                                    data-service="Daycare After Hours (6 AM - 11 PM)"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Daycare + After Hours
                                            </button>

                                            <button class="btn btn-outline-secondary btn-sm svc-btn"
                                                    data-variant="secondary"
                                                    data-service="Boarding"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Boarding
                                            </button>
                                        </div>

                                        <!-- inline booking form -->
                                        <form class="mt-2 d-none day-form" method="post" th:action="@{/booking}">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                            <input type="hidden" name="serviceType">
                                            <input type="hidden" name="date">
                                            <div class="mb-2">
                                                <label class="form-label small">Drop-off time</label>
                                                <select name="time" class="form-select form-select-sm" required>
                                                    <option th:each="t : ${dropoffTimes}" th:value="${t}" th:text="${t}">06:00</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">Number of dogs</label>
                                                <select name="dogCount" class="form-select form-select-sm" id="dogCount">
                                                    <option value="1" selected>1 (default)</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                </select>
                                                <div class="form-text">“1 dog” is the default. Only select a number if more than one.</div>
                                            </div>
                                            <!-- Daycare-only prepay -->
                                            <div class="form-check mb-2 small daycare-only"
                                                 th:classappend="${weekPaid} ? ' opacity-50' : ''">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       name="wantsAdvancePay"
                                                       value="true"
                                                       th:disabled="${weekPaid}">
                                                <label class="form-check-label">Pay in advance</label>
                                                <div class="form-text" data-prepay-msg
                                                     th:text="${weekPaid} ? 'This week is already paid. Additional daycare is at regular rate.' : 'Must be booked ≥ 24 hours in advance to qualify.'">
                                                    Must be booked ≥ 24 hours in advance to qualify.
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <small class="text-muted" data-quote>Est. —</small>
                                            </div>
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-custom btn-sm">Book</button>
                                            </div>
                                        </form>
                                    </div>
                                </div><!-- /col -->
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 2 -->
                    <div class="card shadow-sm mb-2">
                        <div class="card-body" th:with="weekPaid=${week2Paid}">
                            <div class="alert alert-static mb-3 text-center"
                                 th:classappend="${week2Paid} ? ' alert-info' : ' alert-secondary'">
                                <div th:if="${!week2Paid}">
                                    <strong>Plan your week to unlock discounted rates.</strong><br/>
                                    Week:
                                    <span th:text="${#temporals.format(week2Monday, 'MMM d')}"></span>
                                    –
                                    <span th:text="${#temporals.format(week2Monday.plusDays(6), 'MMM d')}"></span>
                                </div>
                                <div th:if="${week2Paid}">
                                    <strong>Week planned:</strong> You’ve already paid for this week’s daycare bundle. Additional daycare this week is regular rate.<br/>
                                    Week:
                                    <span th:text="${#temporals.format(week2Monday, 'MMM d')}"></span>
                                    –
                                    <span th:text="${#temporals.format(week2Monday.plusDays(6), 'MMM d')}"></span>
                                </div>
                            </div>

                            <div class="calendar-head">
                                <!-- Week 2 header -->
                                <h5 class="mb-0" th:text="${#temporals.format(week2Monday, 'MMMM yyyy')}">March 2025</h5>
                            </div>
                            <!-- 7-column calendar grid -->
                            <div class="calendar-grid">
                                <!-- Optional weekday labels row -->
                                <div class="calendar-label">Mon</div>
                                <div class="calendar-label">Tue</div>
                                <div class="calendar-label">Wed</div>
                                <div class="calendar-label">Thu</div>
                                <div class="calendar-label">Fri</div>
                                <div class="calendar-label">Sat</div>
                                <div class="calendar-label">Sun</div>

                                <!-- Days -->
                                <div class="calendar-cell" th:each="d : ${week2Days}">
                                    <span class="badge text-bg-secondary small badge-booked"
                                          th:if="${#maps.containsKey(bookedByDate, d)}"
                                          th:text="${#strings.defaultString(bookedByDate[d], 'Booked')}">Booked</span>
                                    <div th:class="${'day-tile'
                                                      + (d.equals(today) ? ' is-today' : '')
                                                      + (#maps.containsKey(bookedByDate, d) ? ' is-booked' : '')}"
                                         th:attr="aria-current=${d.equals(today)} ? 'date' : null">
                                        <div class="tile-head d-flex justify-content-between align-items-center">
                                            <strong th:text="${#temporals.format(d, 'EEE MMM d')}">Mon Mar 1</strong>
                                            <div class="d-flex gap-2 align-items-center">
                                                <span class="badge bg-primary-subtle text-primary small"
                                                      th:if="${d.equals(today)}">Today</span>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm svc-btn"
                                                    data-variant="primary"
                                                    data-service="Daycare (6 AM - 3 PM)"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Daycare
                                            </button>

                                            <button class="btn btn-outline-primary btn-sm svc-btn"
                                                    data-variant="primary"
                                                    data-service="Daycare (6 AM - 8 PM)"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Daycare + Evening
                                            </button>

                                            <button class="btn btn-outline-primary btn-sm svc-btn"
                                                    data-variant="primary"
                                                    data-service="Daycare After Hours (6 AM - 11 PM)"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Daycare + After Hours
                                            </button>

                                            <button class="btn btn-outline-secondary btn-sm svc-btn"
                                                    data-variant="secondary"
                                                    data-service="Boarding"
                                                    th:attr="data-date=${d}"
                                                    th:disabled="${d.isBefore(today)}"
                                                    th:classappend="${d.isBefore(today)} ? ' disabled' : ''">
                                                Boarding
                                            </button>
                                        </div>

                                        <form class="mt-2 d-none day-form" method="post" th:action="@{/booking}">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                            <input type="hidden" name="serviceType">
                                            <input type="hidden" name="date">
                                            <div class="mb-2">
                                                <label class="form-label small">Drop-off time</label>
                                                <select name="time" class="form-select form-select-sm" required>
                                                    <option th:each="t : ${dropoffTimes}" th:value="${t}" th:text="${t}">06:00</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">Number of dogs</label>
                                                <select name="dogCount" class="form-select form-select-sm" id="dogCount">
                                                    <option value="1" selected>1 (default)</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                </select>
                                                <div class="form-text">“1 dog” is the default. Only select a number if more than one.</div>
                                            </div>
                                            <div class="form-check mb-2 small daycare-only"
                                                 th:classappend="${weekPaid} ? ' opacity-50' : ''">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       name="wantsAdvancePay"
                                                       value="true"
                                                       th:disabled="${weekPaid}">
                                                <label class="form-check-label">Pay in advance</label>
                                                <div class="form-text" data-prepay-msg
                                                     th:text="${weekPaid} ? 'This week is already paid. Additional daycare is at regular rate.' : 'Must be booked ≥ 24 hours in advance to qualify.'">
                                                    Must be booked ≥ 24 hours in advance to qualify.
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <small class="text-muted" data-quote>Est. —</small>
                                            </div>
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-custom btn-sm">Book</button>
                                            </div>
                                        </form>
                                    </div>
                                </div><!-- /col -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pane-your" role="tabpanel" aria-labelledby="tab-your">
            <h1 class="mb-4 text-center">Your Bookings</h1>
            <!-- Your Bookings -->
            <div id="yourBookingsSection" class="bookings-wrap mt-5">
                <div class="wrap-head d-flex align-items-center justify-content-between">
                    <span class="badge text-bg-secondary">Tip: plan Mon–Sun for best weekly rate</span>
                    <h3 class="mb-0 text-center">Your Bookings</h3>
                </div>
                <div class="wrap-body">
                    <div class="row gy-4">
                        <div class="col-md-4">
                            <h5 class="mb-2">Daycare (6 AM - 3 PM)</h5>
                            <ul class="list-group">
                                <li th:each="b : ${bookingsDaycareShort}"
                                    class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold" th:text="${b.serviceType}">Daycare (6 AM - 3 PM)</div>
                                        <div class="text-muted small">
                                            <span th:text="${#temporals.format(b.date, 'MM/dd/yy')}">03/01/25</span>
                                            • Drop-off at
                                            <span th:text="${b.time != null ? #temporals.format(b.time, 'h:mm a') : '—'}">6:00 AM</span>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge badge-status"
                                                  th:classappend="${b.status == 'APPROVED'} ? ' bg-success-subtle text-success' :
                                                                  (${b.status == 'CANCELED'} ? ' bg-danger-subtle text-danger' : ' bg-secondary')"
                                                  th:text="${b.status}">APPROVED</span>
                                            <span class="badge bg-light text-dark ms-2">
                                                <span th:if="${provisionalQuotes != null and provisionalQuotes[b.id] != null}"
                                                      th:text="${#numbers.formatCurrency(provisionalQuotes[b.id])}">$0.00</span>
                                                <span th:if="${provisionalQuotes == null or provisionalQuotes[b.id] == null}">est.</span>
                                            </span>
                                            <span class="badge bg-secondary-subtle text-secondary ms-2"
                                                  th:if="${b.dogCount != null and b.dogCount > 1}"
                                                  th:text="'×' + ${b.dogCount}">×2</span>
                                        </div>
                                    </div>
                                    <div th:if="${b.status == 'APPROVED'}">
                                        <form th:action="@{'/booking/cancel/' + ${b.id}}"
                                              method="post"
                                              class="ms-3 confirm-cancel">
                                            <input type="hidden" th:name="${_csrf.parameterName}"
                                                   th:value="${_csrf.token}"/>
                                            <button class="btn btn-danger-custom btn-sm" type="submit">Cancel</button>
                                        </form>
                                    </div>
                                </li>
                                <li th:if="${#lists.isEmpty(bookingsDaycareShort)}" class="list-group-item text-muted">
                                    No bookings.
                                </li>
                            </ul>
                        </div>

                        <div class="col-md-4">
                            <h5 class="mb-2">Daycare + Evenings(6 AM - 8 PM)</h5>
                            <ul class="list-group">
                                <li th:each="b : ${bookingsDaycareLong}"
                                    class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold" th:text="${b.serviceType}">Daycare (6 AM - 8 PM)</div>
                                        <div class="text-muted small">
                                            <span th:text="${#temporals.format(b.date, 'MM/dd/yy')}">03/01/25</span>
                                            • Drop-off at
                                            <span th:text="${b.time != null ? #temporals.format(b.time, 'h:mm a') : '—'}">6:00 AM</span>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge badge-status"
                                                  th:classappend="${b.status == 'APPROVED'} ? ' bg-success-subtle text-success' :
                                                                  (${b.status == 'CANCELED'} ? ' bg-danger-subtle text-danger' : ' bg-secondary')"
                                                  th:text="${b.status}">APPROVED</span>
                                            <span class="badge bg-light text-dark ms-2">
                                                <span th:if="${provisionalQuotes != null and provisionalQuotes[b.id] != null}"
                                                      th:text="${#numbers.formatCurrency(provisionalQuotes[b.id])}">$0.00</span>
                                                <span th:if="${provisionalQuotes == null or provisionalQuotes[b.id] == null}">est.</span>
                                            </span>
                                            <span class="badge bg-secondary-subtle text-secondary ms-2"
                                                  th:if="${b.dogCount != null and b.dogCount > 1}"
                                                  th:text="'×' + ${b.dogCount}">×2</span>
                                        </div>
                                    </div>
                                    <div th:if="${b.status == 'APPROVED'}">
                                        <form th:action="@{'/booking/cancel/' + ${b.id}}"
                                              method="post"
                                              class="ms-3 confirm-cancel">
                                            <input type="hidden" th:name="${_csrf.parameterName}"
                                                   th:value="${_csrf.token}"/>
                                            <button class="btn btn-danger-custom btn-sm" type="submit">Cancel</button>
                                        </form>
                                    </div>
                                </li>
                                <li th:if="${#lists.isEmpty(bookingsDaycareLong)}" class="list-group-item text-muted">No
                                    bookings.
                                </li>
                            </ul>
                        </div>

                        <div class="col-md-4">
                            <h5 class="mb-2">Daycare + After Hours (6 AM - 11 PM)</h5>
                            <ul class="list-group">
                                <li th:each="b : ${bookingsDaycareAfterHours}"
                                    class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold" th:text="${b.serviceType}">Daycare After Hours (6 AM -
                                            11 PM)
                                        </div>
                                        <div class="text-muted small">
                                            <span th:text="${#temporals.format(b.date, 'MM/dd/yy')}">03/01/25</span>
                                            • Drop-off at
                                            <span th:text="${b.time != null ? #temporals.format(b.time, 'h:mm a') : '—'}">6:00 AM</span>
                                        </div>
                                        <div class="mt-1">
                    <span class="badge badge-status"
                          th:classappend="${b.status == 'APPROVED'} ? ' bg-success-subtle text-success' :
                                          (${b.status == 'CANCELED'} ? ' bg-danger-subtle text-danger' : ' bg-secondary')"
                          th:text="${b.status}">APPROVED</span>
                                            <span class="badge bg-light text-dark ms-2">$90.00</span>
                                            <span class="badge bg-secondary-subtle text-secondary ms-2"
                                                  th:if="${b.dogCount != null and b.dogCount > 1}"
                                                  th:text="'×' + ${b.dogCount}">×2</span>
                                        </div>
                                    </div>
                                    <div th:if="${b.status == 'APPROVED'}">
                                        <form th:action="@{'/booking/cancel/' + ${b.id}}" method="post"
                                              class="ms-3 confirm-cancel">
                                            <input type="hidden" th:name="${_csrf.parameterName}"
                                                   th:value="${_csrf.token}"/>
                                            <button class="btn btn-danger-custom btn-sm" type="submit">Cancel</button>
                                        </form>
                                    </div>
                                </li>
                                <li th:if="${#lists.isEmpty(bookingsDaycareAfterHours)}"
                                    class="list-group-item text-muted">No bookings.
                                </li>
                            </ul>
                        </div>

                        <div class="col-md-4">
                            <h5 class="mb-2">Boarding</h5>
                            <ul class="list-group">
                                <li th:each="b : ${bookingsBoarding}"
                                    class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold" th:text="${b.serviceType}">Boarding</div>
                                        <div class="text-muted small">
                                            <span th:text="${#temporals.format(b.date, 'MM/dd/yy')}">03/01/25</span>
                                            <span th:if="${b.time != null}"> • Drop-off at <span
                                                    th:text="${#temporals.format(b.time, 'h:mm a')}">6:00 AM</span></span>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge badge-status"
                                                  th:classappend="${b.status == 'APPROVED'} ? ' bg-success-subtle text-success' :
                                                                  (${b.status == 'CANCELED'} ? ' bg-danger-subtle text-danger' : ' bg-secondary')"
                                                  th:text="${b.status}">APPROVED</span>
                                            <span th:if="${b.quotedRateAtLock != null}"
                                                  class="badge bg-light text-dark ms-2"
                                                  th:text="${#numbers.formatCurrency(b.quotedRateAtLock)}">$0.00</span>
                                            <span class="badge bg-secondary-subtle text-secondary ms-2"
                                                  th:if="${b.dogCount != null and b.dogCount > 1}"
                                                  th:text="'×' + ${b.dogCount}">×2</span>
                                        </div>
                                    </div>
                                    <div th:if="${b.status == 'APPROVED'}">
                                        <form th:action="@{'/booking/cancel/' + ${b.id}}"
                                              method="post"
                                              class="ms-3 confirm-cancel">
                                            <input type="hidden" th:name="${_csrf.parameterName}"
                                                   th:value="${_csrf.token}"/>
                                            <button class="btn btn-danger-custom btn-sm" type="submit">Cancel</button>
                                        </form>
                                    </div>
                                </li>
                                <li th:if="${#lists.isEmpty(bookingsBoarding)}" class="list-group-item text-muted">No
                                    bookings.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Your Bookings -->

        <!-- Uploads pane -->
        <div class="tab-pane fade" id="pane-uploads" role="tabpanel" aria-labelledby="tab-uploads">
            <div class="section-card">
                <div class="section-head">
                    <h3 class="mb-0">Upload Vaccine/Records</h3>
                </div>
                <div class="section-body">
                    <form th:action="@{/uploads}" method="post" enctype="multipart/form-data" class="row g-3">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <div class="col-md-4">
                            <label class="form-label">File</label>
                            <input type="file" class="form-control" name="file" required>
                            <div class="form-text">Allowed: PDF, JPG, PNG (max 10MB)</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Display name (optional)</label>
                            <input type="text" class="form-control" name="displayName" placeholder="Rabies Vaccine">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Expiration date (optional)</label>
                            <input type="date" class="form-control" name="expirationDate">
                        </div>
                        <div class="col-12">
                            <button class="btn btn-custom">Upload</button>
                        </div>
                    </form>

                    <hr class="my-4 hr-dashed"/>

                    <h4>Your Files</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>File</th>
                                <th>Display Name</th>
                                <th>Expires</th>
                                <th>Uploaded</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="f : ${files}">
                                <td th:text="${f.fileName}">VetRecord.pdf</td>
                                <td th:text="${f.displayName != null ? f.displayName : '—'}">Rabies Vaccine</td>
                                <td th:text="${f.expirationDate != null ? f.expirationDate : '—'}">2026-05-01</td>
                                <td th:text="${#temporals.format(f.createdAt, 'yyyy-MM-dd HH:mm')}">2025-09-03 10:15</td>
                                <td class="text-end">
                                    <a class="btn btn-sm btn-outline-secondary" th:href="@{'/uploads/' + ${f.id} + '/download'}">Download</a>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(files)}"><td colspan="5" class="text-center text-muted">No files uploaded yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div><!-- /section-card -->
        </div>
    </div>
</div>

<!-- Tabs (hash) -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const activateFromHash = () => {
            const hash = window.location.hash;
            if (!hash) return;
            const btn = document.querySelector(`button[data-bs-target="${hash}"]`);
            if (btn && window.bootstrap) new bootstrap.Tab(btn).show();
            if (hash === '#uploads') {
                const ubtn = document.querySelector('#tab-uploads');
                if (ubtn && window.bootstrap) new bootstrap.Tab(ubtn).show();
            }
        };
        activateFromHash();
        window.addEventListener('hashchange', activateFromHash);
    });
</script>

<!-- Service selection + prepay eligibility (per day tile) -->
<script th:inline="javascript">
    (function() {
        function hoursUntil(dateStr, timeStr) {
            if (!dateStr || !timeStr) return 0;
            const dt = new Date(`${dateStr}T${timeStr}:00`);
            const now = new Date();
            return (dt.getTime() - now.getTime()) / (1000*60*60);
        }

        async function fetchWeekPaid(isoDate) {
            try {
                const res = await fetch(`/booking/week-paid?date=${encodeURIComponent(isoDate)}`, {
                    headers: { 'Accept': 'application/json' }
                });
                if (!res.ok) return { weekPaid: false };
                return await res.json();
            } catch {
                return { weekPaid: false };
            }
        }

        function setActive(btn, isActive) {
            const variant = btn.getAttribute('data-variant') || 'primary';
            btn.classList.toggle('active', isActive);
            if (variant === 'secondary') {
                btn.classList.toggle('btn-outline-secondary', !isActive);
                btn.classList.toggle('btn-secondary', isActive);
            } else {
                btn.classList.toggle('btn-outline-primary', !isActive);
                btn.classList.toggle('btn-primary', isActive);
            }
        }

        function clearActiveSiblings(buttons) {
            buttons.forEach(b => setActive(b, false));
        }

        // --- NEW: keep only one day expanded at a time ---
        function closeAllDayForms(exceptTile){
            document.querySelectorAll('.day-form').forEach(f=>{
                if(!exceptTile || !exceptTile.contains(f)){
                    f.classList.add('d-none');
                }
            });
            document.querySelectorAll('.svc-btn.active').forEach(b=>{
                // remove "active" styling from buttons in other tiles
                const variant = b.getAttribute('data-variant') || 'primary';
                b.classList.remove('active');
                if (variant === 'secondary') {
                    b.classList.add('btn-outline-secondary');
                    b.classList.remove('btn-secondary');
                } else {
                    b.classList.add('btn-outline-primary');
                    b.classList.remove('btn-primary');
                }
            });
        }

        function wireDayTile(tile) {
            const svcButtons = tile.querySelectorAll('.svc-btn');
            const form = tile.querySelector('.day-form');
            if (!form) return;
            const svcInput = form.querySelector('input[name="serviceType"]');
            const dateInput = form.querySelector('input[name="date"]');
            const timeSelect = form.querySelector('select[name="time"]');
            const daycareBlock = form.querySelector('.daycare-only');
            const prepayChk = form.querySelector('input[name="wantsAdvancePay"]');
            const prepayMsg = form.querySelector('[data-prepay-msg]');

            async function refreshPrepay(serviceType, dateStr, timeStr) {
                const svcLower = (serviceType || '').toLowerCase();
                const isDaycare = svcLower.includes('daycare');
                const isAfterHours = svcLower.includes('after hours'); // NEW
                daycareBlock.classList.toggle('d-none', !isDaycare || isAfterHours); // hide for After Hours
                if (!isDaycare || isAfterHours) return;

                const info = await fetchWeekPaid(dateStr);
                const weekPaid = !!info.weekPaid;
                const hrs = hoursUntil(dateStr, timeStr);
                const eligible = !weekPaid && hrs >= 24;

                prepayChk.disabled = !eligible;
                if (!eligible && prepayChk.checked) prepayChk.checked = false;
                if (prepayMsg) {
                    prepayMsg.textContent = weekPaid
                        ? 'This week is already paid. Additional daycare bookings are regular rate.'
                        : (hrs >= 24 ? '' : 'Must be booked ≥ 24 hours in advance to qualify.');
                }
            }

            // click handlers
            svcButtons.forEach(btn => {
                btn.addEventListener('click', async () => {

                    if (btn.disabled || btn.classList.contains('disabled')) return;

                    const svc = btn.getAttribute('data-service');
                    const d = btn.getAttribute('data-date');

                    // NEW: collapse others first
                    closeAllDayForms(tile);

                    // open this form and activate this service
                    form.classList.remove('d-none');
                    svcInput.value = svc;
                    dateInput.value = d;

                    clearActiveSiblings(Array.from(svcButtons));
                    setActive(btn, true);

                    prepayChk.checked = false;
                    await refreshPrepay(svc, d, timeSelect.value);

                    // optional: keep the opened tile in view on small screens
                    try { tile.scrollIntoView({ block:'nearest', behavior:'smooth' }); } catch {}
                });
            });

            timeSelect.addEventListener('change', async () => {
                await refreshPrepay(svcInput.value, dateInput.value, timeSelect.value);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.day-tile').forEach(wireDayTile);
        });
    })();
</script>

<style>
    /* make disabled buttons truly inert to clicks */
    .svc-btn:disabled { pointer-events: none; }
</style>

<!-- Keep ALL weekly banners permanently visible (guarded) -->
<script>
    (function () {
        const SELECTOR = '.alert.alert-static';
        function isActuallyHidden(el) {
            const cs = window.getComputedStyle(el);
            return el.hasAttribute('hidden') ||
                el.getAttribute('aria-hidden') === 'true' ||
                cs.display === 'none' ||
                cs.visibility === 'hidden' ||
                parseFloat(cs.opacity || '1') < 0.99;
        }
        function KEEP_VISIBLE(banner) {
            if (!isActuallyHidden(banner)) return;
            banner.classList.add('alert-static');
            banner.removeAttribute('hidden');
            banner.removeAttribute('aria-hidden');
            banner.style.removeProperty('display');
            banner.style.visibility = 'visible';
            banner.style.opacity = '1';
            banner.style.removeProperty('animation');
            banner.style.removeProperty('transition');
            banner.dataset.pinned = '1';
        }
        document.querySelectorAll(SELECTOR).forEach(KEEP_VISIBLE);
        const observer = new MutationObserver((mutations, obs) => {
            const banners = document.querySelectorAll(SELECTOR);
            let needsFix = false;
            banners.forEach(b => {
                if (b.dataset.pinned === '1') return;
                if (isActuallyHidden(b)) needsFix = true;
            });
            if (!needsFix) return;
            obs.disconnect();
            banners.forEach(b => { if (b.dataset.pinned !== '1') KEEP_VISIBLE(b); });
            obs.observe(document.documentElement, {
                attributes: true, childList: true, subtree: true,
                attributeFilter: ['hidden','aria-hidden','class','style']
            });
        });
        observer.observe(document.documentElement, {
            attributes: true, childList: true, subtree: true,
            attributeFilter: ['hidden','aria-hidden','class','style']
        });
    })();
</script>

<!-- Live quote hook -->
<script th:inline="javascript">
    (function () {
        async function fetchQuote({ svc, dateStr, timeStr, wantsAdvance, dogCount }) {
            const params = new URLSearchParams({
                serviceType: svc,
                date: dateStr,
                wantsAdvancePay: wantsAdvance ? 'true' : 'false'
            });
            if (timeStr) params.set('time', timeStr);
            if (dogCount) params.set('dogCount', String(dogCount)); // backend may use; harmless if ignored
            try {
                const res = await fetch('/booking/quote?' + params.toString(), { headers: { 'Accept': 'application/json' } });
                if (!res.ok) return null;
                return await res.json();
            } catch { return null; }
        }
        function fmtMoneyUSD(n){
            try{ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n); }
            catch{ return '$'+Number(n||0).toFixed(2); }
        }
        function wireDayTile(tile){
            const form = tile.querySelector('.day-form'); if(!form) return;
            const svcInput=form.querySelector('input[name="serviceType"]');
            const dateInput=form.querySelector('input[name="date"]');
            const timeSel=form.querySelector('select[name="time"]');
            const prepayChk=form.querySelector('input[name="wantsAdvancePay"]');
            const dogSel=form.querySelector('select[name="dogCount"]');
            const quoteEl=form.querySelector('[data-quote]');
            function getDogCount(){ return Number(dogSel?.value||'1')||1; }

            async function refreshQuote(){
                if(!quoteEl) return;
                const svc=svcInput.value, d=dateInput.value, t=timeSel?.value||'', wants=!!(prepayChk&&prepayChk.checked);
                if(!svc||!d){ quoteEl.textContent='Est. —'; return; }
                const nDogs=getDogCount();
                const q=await fetchQuote({svc,dateStr:d,timeStr:t,wantsAdvance:wants,dogCount:nDogs});
                if(!q||!q.amount){ quoteEl.textContent='Est. —'; return; }
                quoteEl.textContent='Est. '+fmtMoneyUSD(Number(q.amount));
                quoteEl.title=q.note||'';
            }

            tile.querySelectorAll('.svc-btn').forEach(btn=>btn.addEventListener('click', refreshQuote));
            timeSel?.addEventListener('change', refreshQuote);
            prepayChk?.addEventListener('change', refreshQuote);
            dogSel?.addEventListener('change', refreshQuote);
            refreshQuote();
        }
        document.addEventListener('DOMContentLoaded', ()=>{ document.querySelectorAll('.day-tile').forEach(wireDayTile); });
    })();
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('form.confirm-cancel').forEach(function (f) {
            f.addEventListener('submit', function (e) {
                if (!window.confirm('Cancel this booking? This cannot be undone.')) {
                    e.preventDefault();
                }
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const titleEl = document.getElementById('pageTitle');
        if (!titleEl) return;

        const TITLE_BOOKING = 'Book a Service';
        const TITLE_UPLOADS = 'Upload Files';

        function setTitlesFor(targetPane) {
            const isUploads = (targetPane === '#pane-uploads');
            const text = isUploads ? TITLE_UPLOADS : TITLE_BOOKING;
            // page title
            titleEl.textContent = text;
            // browser tab title
            document.title = text + ' | Dog Plaza';
        }

        // On tab change (Bootstrap event)
        const tabsEl = document.getElementById('custTabs');
        if (tabsEl) {
            tabsEl.addEventListener('shown.bs.tab', function (ev) {
                const target = ev.target?.getAttribute('data-bs-target');
                if (target) setTitlesFor(target);
            });
        }

        // On initial load (with or without hash)
        const initialHash = window.location.hash || '#pane-booking';
        setTitlesFor(initialHash);

        // If the hash changes later (e.g., user types URL hash)
        window.addEventListener('hashchange', function () {
            setTitlesFor(window.location.hash || '#pane-booking');
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function(){
        var el = document.getElementById('ratesCollapse');
        if (!el) return;
        var w = window.innerWidth || document.documentElement.clientWidth;
        var collapse = window.bootstrap ? window.bootstrap.Collapse.getOrCreateInstance(el) : null;
        if (!collapse) return;
        // If small screen and it's shown (because of server render), hide it.
        if (w < 768 && el.classList.contains('show')) { collapse.hide(); }
        // If medium+ and it's hidden, show it.
        if (w >= 768 && !el.classList.contains('show')) { collapse.show(); }
    });
</script>
<script th:src="@{/js/custom.js?v=20251103}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    setupPersistentCollapse({
        collapseId: 'ratesCollapse',
        buttonId: 'ratesToggleBtn',
        storageKey: 'bookingRatesCollapsed',
        applyOnMaxWidth: 767
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('#custTabs [data-bs-toggle="tab"]');
        if (!window.bootstrap || !tabs.length) return;

        // Open tab from hash (e.g., #pane-your or #pane-uploads)
        const openFromHash = () => {
            const hash = window.location.hash;
            if (!hash) return;
            const btn = document.querySelector(`#custTabs [data-bs-target="${hash}"]`);
            if (btn) bootstrap.Tab.getOrCreateInstance(btn).show();
        };
        openFromHash();
        window.addEventListener('hashchange', openFromHash);

        // Keep hash in sync and scroll to top on tab change
        tabs.forEach(btn => {
            btn.addEventListener('shown.bs.tab', () => {
                const target = btn.getAttribute('data-bs-target');
                if (target) history.replaceState(null, '', target);
                // Always scroll to top after switching tabs
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('#custTabs [data-bs-toggle="tab"]');
        if (!window.bootstrap || !tabs.length) return;

        // open from hash if present
        const openFromHash = () => {
            const hash = window.location.hash;
            if (!hash) return;
            const btn = document.querySelector(`#custTabs [data-bs-target="${hash}"]`);
            if (btn) bootstrap.Tab.getOrCreateInstance(btn).show();
        };
        openFromHash();
        window.addEventListener('hashchange', openFromHash);

        // keep hash in sync when user clicks tabs
        tabs.forEach(btn => {
            btn.addEventListener('shown.bs.tab', () => {
                const target = btn.getAttribute('data-bs-target');
                if (target) history.replaceState(null, '', target);
            });
        });
    });
</script>
</body>
</html>
